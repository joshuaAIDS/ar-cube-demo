<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Markerless AR Cube</title>
  <script src="https://aframe.io/releases/1.4.2/aframe.min.js"></script>
  <style>
    body, html { margin:0; padding:0; overflow:hidden; }
    #instructions {
      position:absolute; top:10px; left:50%;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.6);
      color:white; padding:10px 20px; border-radius:8px;
      font-family:sans-serif; z-index:10;
    }
  </style>
</head>
<body>
<div id="instructions">Tap to place cube</div>

<a-scene 
  xrweb="requiredFeatures: hit-test; optionalFeatures: dom-overlay" 
  embedded 
  renderer="colorManagement: true; foveationLevel: 2"
  arjs="trackingMethod: best; debugUIEnabled: false">

  <a-entity id="camera" camera look-controls position="0 1.6 0"></a-entity>

  <a-box id="cube" color="#ff0000" depth="0.3" height="0.3" width="0.3" visible="false"></a-box>

</a-scene>

<script>
const scene = document.querySelector('a-scene');
const cube = document.getElementById('cube');
let hitTestSource = null;
let localSpace = null;

scene.addEventListener('enter-vr', async () => {
  const xrSession = scene.renderer.xr.getSession();
  if (!xrSession) return;

  // Request reference spaces
  const viewerSpace = await xrSession.requestReferenceSpace('viewer');
  hitTestSource = await xrSession.requestHitTestSource({ space: viewerSpace });
  localSpace = await xrSession.requestReferenceSpace('local-floor');

  xrSession.addEventListener('end', () => {
    hitTestSource = null;
    localSpace = null;
  });
});

// Tap to place cube
window.addEventListener('touchstart', async () => {
  if (!hitTestSource || !localSpace) return;
  const xrFrame = scene.renderer.xr.getFrame();
  if (!xrFrame) return;

  const hitTestResults = xrFrame.getHitTestResults(hitTestSource);
  if (hitTestResults.length > 0) {
    const hit = hitTestResults[0];
    const pose = hit.getPose(localSpace);

    cube.object3D.position.set(
      pose.transform.position.x,
      pose.transform.position.y,
      pose.transform.position.z
    );

    cube.object3D.quaternion.set(
      pose.transform.orientation.x,
      pose.transform.orientation.y,
      pose.transform.orientation.z,
      pose.transform.orientation.w
    );

    cube.setAttribute('visible', 'true');
  }
});
</script>
</body>
</html>

